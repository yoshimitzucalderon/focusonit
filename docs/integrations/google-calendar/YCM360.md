# Configuracion de Google OAuth - YCM360 Production

## Configuracion Actual del Servidor

```
Servidor: vmi2658765
Path: /opt/supabase/supabase/docker/
Supabase API: https://api.ycm360.com
Supabase Studio: https://supabase.ycm360.com
Frontend: https://focusonit.ycm360.com
```

---

## PASO 1: Actualizar .env

Conectate a tu servidor y edita el archivo `.env`:

```bash
ssh root@vmi2658765
cd /opt/supabase/supabase/docker
nano .env
```

**AGREGAR** estas lineas **AL FINAL** del archivo:

```bash
############
# Google OAuth Configuration
############

GOOGLE_CLIENT_ID=your-client-id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your-client-secret
```

**IMPORTANTE**:

- Reemplaza `your-client-id.apps.googleusercontent.com` con tu Client ID de Google Cloud Console
- Reemplaza `your-client-secret` con tu Client Secret de Google Cloud Console

Guarda el archivo (`Ctrl+O`, `Enter`, `Ctrl+X`).

---

## PASO 2: Actualizar docker-compose.yml

Edita el archivo `docker-compose.yml`:

```bash
nano docker-compose.yml
```

**BUSCA** la seccion `auth:` (aproximadamente linea 77) y **AGREGA** estas lineas en la seccion `environment:`:

```yaml
  auth:
    container_name: supabase-auth
    image: supabase/gotrue:v2.177.0
    restart: unless-stopped
    environment:
      # ... todas las variables existentes ...

      # Google OAuth Configuration
      GOTRUE_EXTERNAL_GOOGLE_ENABLED: "true"
      GOTRUE_EXTERNAL_GOOGLE_CLIENT_ID: "${GOOGLE_CLIENT_ID}"
      GOTRUE_EXTERNAL_GOOGLE_SECRET: "${GOOGLE_CLIENT_SECRET}"
      GOTRUE_EXTERNAL_GOOGLE_REDIRECT_URI: "https://api.ycm360.com/auth/v1/callback"
```

**IMPORTANTE**: Asegurate de que la indentacion sea correcta (2 espacios para cada nivel).

Guarda el archivo (`Ctrl+O`, `Enter`, `Ctrl+X`).

---

## PASO 3: Reiniciar Servicios

Reinicia el servicio de autenticacion:

```bash
cd /opt/supabase/supabase/docker
docker compose restart auth
```

Espera unos segundos y verifica que este corriendo:

```bash
docker compose logs -f auth
```

**Busca esta linea** en los logs:

```
msg="GoTrue API started" port=9999
```

Presiona `Ctrl+C` para salir de los logs.

---

## PASO 4: Verificar Configuracion

### A. Health Check

```bash
curl https://api.ycm360.com/auth/v1/health
```

**Respuesta esperada**:

```json
{
  "version": "v2.177.0",
  "name": "GoTrue",
  "description": "GoTrue is a user management API"
}
```

### B. Verificar que Google esta habilitado

```bash
curl https://api.ycm360.com/auth/v1/settings | jq '.external.google'
```

**Respuesta esperada**:

```json
true
```

Si no tienes `jq` instalado, instalalo:

```bash
apt-get update && apt-get install -y jq
```

### C. Verificar Variables de Entorno

```bash
docker compose exec auth env | grep GOTRUE_EXTERNAL_GOOGLE
```

**Deberia mostrar**:

```
GOTRUE_EXTERNAL_GOOGLE_ENABLED=true
GOTRUE_EXTERNAL_GOOGLE_CLIENT_ID=tu-client-id.apps.googleusercontent.com
GOTRUE_EXTERNAL_GOOGLE_SECRET=tu-client-secret
GOTRUE_EXTERNAL_GOOGLE_REDIRECT_URI=https://api.ycm360.com/auth/v1/callback
```

---

## PASO 5: Configurar Google Cloud Console

### A. Crear Proyecto (si no existe)

1. Ve a https://console.cloud.google.com/
2. Crea un nuevo proyecto: "FocusOnIt Production"

### B. Habilitar Google Calendar API

1. APIs & Services → Library
2. Busca "Google Calendar API"
3. Haz clic en "Enable"

### C. Configurar Pantalla de Consentimiento OAuth

1. APIs & Services → OAuth consent screen
2. Tipo de usuario: **Externo**
3. Rellena:
   - **Nombre de la app**: FocusOnIt
   - **Email de soporte**: tu-email@example.com
   - **Logo**: (opcional)
   - **Dominio de la aplicacion**: `ycm360.com`
   - **Dominios autorizados**: `ycm360.com`
4. Ambitos (Scopes):
   - `openid`
   - `email`
   - `profile`
   - (Opcional) `https://www.googleapis.com/auth/calendar.events`
5. Usuarios de prueba (si es necesario):
   - Agrega tu email para testing

### D. Crear Credenciales OAuth 2.0

1. APIs & Services → Credentials
2. "Create Credentials" → "OAuth 2.0 Client ID"
3. Tipo de aplicacion: **Aplicacion web**
4. Nombre: `FocusOnIt Web Client`

5. **JavaScript origins autorizados**:

   ```
   https://api.ycm360.com
   https://focusonit.ycm360.com
   http://localhost:3000
   ```

6. **URIs de redireccion autorizados**:

   ```
   https://api.ycm360.com/auth/v1/callback
   https://focusonit.ycm360.com/auth/callback
   http://localhost:3000/auth/callback
   ```

7. Haz clic en "Create"

8. **COPIA** el Client ID y Client Secret que aparecen

---

## PASO 6: Actualizar .env con Credenciales Reales

Edita de nuevo el `.env`:

```bash
nano .env
```

**REEMPLAZA** las lineas que agregaste antes:

```bash
############
# Google OAuth Configuration
############

GOOGLE_CLIENT_ID=123456789-abcdefghijklmnop.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-abc123def456ghi789
```

(Con tus credenciales reales de Google)

Guarda y reinicia auth:

```bash
docker compose restart auth
```

---

## PASO 7: Probar desde el Frontend

### A. Actualizar .env.local en tu proyecto Next.js

En tu maquina local, edita `task-manager/.env.local`:

```bash
# Supabase Self-Hosted
NEXT_PUBLIC_SUPABASE_URL=https://api.ycm360.com
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlzcyI6InN1cGFiYXNlIiwiaWF0IjoxNzU4MjI4ODQzLCJleHAiOjQxMDI0NDQ4MDB9.d5JknOjhScFWEDTQi3LFA0yThHCsZP5FHSZIj4uiQCc
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoic2VydmljZV9yb2xlIiwiaXNzIjoic3VwYWJhc2UiLCJpYXQiOjE3NTgyMjg4NDMsImV4cCI6NDEwMjQ0NDgwMH0.msT1BsBQ9-ewpMDFcVvPQn_xltJtxl35mihha2F-Dzs

# N8N
N8N_VOICE_TASK_WEBHOOK_URL=https://n8n.ycm360.com/webhook/voice-task

# Google Calendar OAuth
GOOGLE_CLIENT_ID=123456789-abcdefghijklmnop.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-abc123def456ghi789
GOOGLE_REDIRECT_URI=http://localhost:3000/api/calendar/oauth/callback
NEXTAUTH_SECRET=d8afb08f80b5e27f3a51d0cb3faa7cc96e0c230fbc862dab30ac4525edeca352

# Produccion (comentado por ahora)
# GOOGLE_REDIRECT_URI=https://focusonit.ycm360.com/api/calendar/oauth/callback
```

**Nota**: Usa el mismo `JWT_SECRET` de tu servidor como `NEXTAUTH_SECRET`.

### B. Probar el Login

1. Ejecuta `npm run dev`
2. Abre http://localhost:3000/login
3. Haz clic en "Continuar con Google"
4. Selecciona tu cuenta de Google
5. Autoriza los permisos
6. Deberias ser redirigido a `/today`

---

## Verificacion en la Base de Datos

Verifica que el usuario se creo:

```bash
# En el servidor
docker compose exec db psql -U postgres -d postgres

# Dentro de psql:
SELECT id, email, provider, created_at FROM auth.users;

# Salir de psql:
\q
```

---

## Troubleshooting

### Error: "Provider not enabled"

```bash
# Verificar configuracion
docker compose exec auth env | grep GOTRUE_EXTERNAL_GOOGLE

# Ver logs
docker compose logs auth | tail -50

# Reiniciar
docker compose restart auth
```

### Error: "redirect_uri_mismatch"

Verifica que en Google Cloud Console tengas exactamente:

```
https://api.ycm360.com/auth/v1/callback
```

### No redirige despues de autorizar

Verifica `GOTRUE_URI_ALLOW_LIST` en docker-compose.yml:

```yaml
GOTRUE_URI_ALLOW_LIST: https://focusonit.ycm360.com,http://localhost:3000
```

### Cookies no funcionan

Verifica `GOTRUE_SITE_URL` en docker-compose.yml:

```yaml
GOTRUE_SITE_URL: https://focusonit.ycm360.com
```

---

## Script de Verificacion Completo

Crea este script en el servidor:

```bash
cat > /root/verify-google-oauth.sh << 'EOF'
#!/bin/bash

echo "Verificando Google OAuth en Supabase..."

cd /opt/supabase/supabase/docker

echo -e "\n1. Variables de entorno:"
docker compose exec auth env | grep GOTRUE_EXTERNAL_GOOGLE

echo -e "\n2. Health check:"
curl -s https://api.ycm360.com/auth/v1/health | jq .

echo -e "\n3. Google provider status:"
curl -s https://api.ycm360.com/auth/v1/settings | jq '.external.google'

echo -e "\n4. Ultimos logs de auth:"
docker compose logs --tail=20 auth

echo -e "\nVerificacion completada"
EOF

chmod +x /root/verify-google-oauth.sh
```

Ejecutar:

```bash
/root/verify-google-oauth.sh
```

---

## Checklist Final

### En el Servidor (vmi2658765)

- [ ] `.env` actualizado con `GOOGLE_CLIENT_ID` y `GOOGLE_CLIENT_SECRET`
- [ ] `docker-compose.yml` actualizado con variables `GOTRUE_EXTERNAL_GOOGLE_*`
- [ ] Servicio auth reiniciado: `docker compose restart auth`
- [ ] Verificado que Google esta habilitado: `curl https://api.ycm360.com/auth/v1/settings`

### En Google Cloud Console

- [ ] Proyecto creado
- [ ] Google Calendar API habilitada
- [ ] OAuth consent screen configurado
- [ ] Credenciales OAuth 2.0 creadas
- [ ] URIs de redireccion agregados:
  - [ ] `https://api.ycm360.com/auth/v1/callback`
  - [ ] `https://focusonit.ycm360.com/auth/callback`
  - [ ] `http://localhost:3000/auth/callback`

### En el Frontend

- [ ] `.env.local` actualizado
- [ ] `react-icons` instalado
- [ ] Pagina de login actualizada
- [ ] Callback handler creado
- [ ] Servidor de desarrollo corriendo

### Prueba Final

- [ ] Login con Google funciona
- [ ] Usuario aparece en `auth.users`
- [ ] Sesion persiste al refrescar
- [ ] Logout funciona

---

## Siguiente Paso

Una vez que funcione el login con Google, puedes agregar:

1. Modal de bienvenida para nuevos usuarios
2. Conectar Google Calendar (opcional) desde Settings
3. Sincronizacion automatica de tareas

---

Para mas detalles tecnicos, consulta [IMPLEMENTATION.md](IMPLEMENTATION.md).

Para setup general (no especifico de YCM360), consulta [SETUP.md](SETUP.md).
